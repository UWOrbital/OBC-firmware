# OBC-firmware

This repository holds all the code that runs on our CubeSat's onboard computer (OBC).

## Table of Contents

- [OBC-firmware](#obc-firmware)
  - [Table of Contents](#table-of-contents)
  - [About the Project](#about-the-project)
  - [Getting Started](#getting-started)
    - [Dependencies](#dependencies)
    - [Getting the Source](#getting-the-source)
    - [Building](#building)
    - [Flashing and Debugging](#flashing-and-debugging)
  - [Contributing](#contributing)
    - [Developing for different target systems](#developing-for-different-target-systems)
  - [Style Guide](#style-guide)
    - [Comments](#comments)
      - [Single Line Comments](#single-line-comments)
      - [Function Comments](#function-comments)
      - [File Header Comments](#file-header-comments)
    - [****Naming and typing conventions****](#naming-and-typing-conventions)
  - [Authors](#authors)

## About the Project

* `adcs/`
    * All code for the attitude determination and control system subsystem.
* `cdh/`
    * All code for the command and data handling subsystem.
* `comms/`
    * All code for the communications subsystem.
* `freertos/ports/`
    * `rm46/`
        * All FreeRTOS code for the RM46L852.
    * `posix/`
        * All FreeRTOS code for a Posix platform.
* `hal/`
    * The hardware abstraction layer generated by HALCoGen.
* `payload/`
    * All code for the primary and secondary payload.
* `posix_utils/`
    * All utility code for running on a Posix platform.

**[Back to top](#table-of-contents)**

## Getting Started

This section will explain how to set up the repo, and how to build, flash, and debug the code.

### Dependencies

The following software should be installed:
* GCC ARM Embedded Toolchain
* UniFlash
* OpenOCD
* Code Composer Studio

**Instructions on how to install these tools can be found on [this Notion page.](https://www.notion.so/uworbital/OBC-Firmware-Development-Workflow-ab037261ce6c45189ea5ca8486b02c6b)**

### Getting the Source

This project is [hosted on GitHub](https://github.com/UWOrbital/OBC-firmware). You can clone this project directly using this command:
```
git clone git@github.com:UWOrbital/OBC-firmware.git
```

### Building

This project can be built for ARM (RM46L852) or Posix systems. 

If you want to build for the RM46, run:

```bash
make clean # Delete any previous build files
make rm46
```

If you want to test the code on a Posix system, run:

```bash
make clean # Delete any previous build files
make posix
./build/OBC-firmware # Runs the binary
```
**Disclaimer:** The firmware built for Posix will not test any RM46 HAL-specific code.

If you get a main() already defined error, go remove the file hal/source/sys_main.c.

More information can be found on [this Notion page.](https://www.notion.so/uworbital/OBC-Firmware-Development-Workflow-ab037261ce6c45189ea5ca8486b02c6b)

### Flashing and Debugging
1. Build the binary for the RM46. The binary can the be found at `build/OBC-firmware.out`
2. Open UniFlash and flash the binary onto the microcontroller

Information about flashing the device and debugging can be found on [this Notion page.](https://www.notion.so/uworbital/OBC-Firmware-Development-Workflow-ab037261ce6c45189ea5ca8486b02c6b)

## Contributing
1. Make sure you're added as a member to the UW Orbital organization on GitHub.
2. Create a feature branch for whatever task you're working on.
    * Our branch naming scheme is `<subteam>/<developer_name>/<feature_description>`. Ignore the `<developer_name>` part if the branch has multiple developers.
    * Example: `cdh/daniel/implement-random-device-driver`
    * Another example: `cdh/implement-random-device-driver`
3. Make a PR. Make sure to at least add the CDH leads as reviewers and ping the CDH pr channel on Discord. You may also want to add your subteam lead(s) as a reviewer if you're not on CDH.
    * Pull requests should include information on, at minimum, the purpose of the PR, new changes made in the PR, tests performed to verify that the code works, and changes that can be made in future iterations of the feature. See [this sample template](https://github.com/UWOrbital/CC1120Driver/blob/main/.github/pull_request_template.md) for more. Itâ€™s good practice to have a PR template in a .github folder in every repository you create. GitHub will pull from this template every time a new PR is made.
5. Make any requested changes and merge your branch onto main once the PR is approved.

### Developing for different target systems
In order to keep the system buildable for both RM46 and Posix, alternative logic mus be provided for hardware-specific code.
```c
#ifndef POSIX_BUILD 
<Code that relies on RM46 HAL. This is what will run on the RM46.>
#else
<Alternative code for when system is runon a Posix system>
#endif
```
Here are a few examples:
```c
#include "FreeRTOS.h"
#include "os_task.h"

#ifndef POSIX_BUILD
#include "gio.h"
#include "sys_common.h"
#else
#include "console.h"
#include "stdint.h"
#endif
```

```c
while (1) {
   #ifndef POSIX_BUILD
   gioToggleBit(gioPORTB, 1); // RM46-specific code
   #else
   console_print("LED Toggled\n"); // Posix-specific code
   #endif
}
```

```c
uint16_t temperature;
#ifndef POSIX_BUILD
temperature = read_temp_sensor();
#else
temperature = 100;
#endif
```

**[Back to top](#table-of-contents)**

## Style Guide

### Comments

#### Single Line Comments

Variable and function names should be descriptive enough to understand even without comments, but if comments are needed to explain parts of the code, use single line comments with the `/* */` notation for better compatibility with old compilers in C.
```c
/* Single line comment */
// Do not use this for C code
```
#### Function Comments

Function comments should exist in both the .h and .c files optimally, but at minimum they should be available in the .h files. Comments should follow the format shown below:
```c
/**
 * @brief Adds two numbers together
 * 
 * @param num1 - The first number to add.
 * @param num2 - The second number to add.
 * @return uint8_t - Returns the sum of of the two numbers.
 */
uint8_t add_numbers(uint8_t num1, uint8_t num2);
```

#### File Header Comments

-   File comments are not required

### ****Naming and typing conventions****

-   `variableNames` in camelCase
-   `function_names()` in snake_case
-   `ClassNames` in PascalCase (UpperCamelCase)
-   `CONSTANT_NAMES` in CAPITAL_SNAKE_CASE
-   `file_names` in snake_case
-   4 spaces per level of indentation
-   Use spaces after opening brackets for conditionals and loops (e.g. `if ()` and `while ()`), but not for function calls (i.e. `my_func()`).
-   Operators:
    -   No spaces around `*`, `/`, `%`, `!`
    -   One space on either side of `=`, `==`, `+`, `-`, `+=`, `-=`, etc
    -   One space after every comma `my_func(var1, var2, var3)`
-   Import statments should be grouped in the following order:
    1.  Local imports (e.g. `#include "cc1120_driver.h`)
    2.  External library imports (e.g. `#include <semphr.h>`)
    3.  Standard library imports (e.g. `#include <stdint.h>`)
-   160 character limit per line (not a hard limit, use common sense)
-   Hanging indents should be aligned to delimeter:

```c
my_function(hasToo,
            many, variables)
```
**[Back to top](#table-of-contents)**

## Authors
This repository was developed by the members of UW Orbital, the University of Waterloo's CubeSat design team.

**[Back to top](#table-of-contents)**
